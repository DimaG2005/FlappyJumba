<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Flappy Bird Telegram</title>
<style>
    body { margin:0; overflow:hidden; background:#87CEEB; }
    canvas { display:block; }
</style>
</head>
<body>
<canvas id="game"></canvas>
<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let bird = { x:80, y:canvas.height/2, size:40, velocity:0 };
let gravity = 0.35, jumpPower = -8.5;
let pipes = [], pipeGap = 250, pipeSpeed = 4, pipeSpawnInterval = 1500, pipeTimer;
let coins = [], coinsCollected = 0;
let score = 0, gameActive = false;

// -------------------- ФОН --------------------
const bg = new Image();
bg.src = "komar.jpg";

// -------------------- МОНЕТКИ --------------------
function spawnCoin(pipe){
    const coinY = pipe.top + Math.random() * (pipe.bottom - pipe.top - 30);
    coins.push({ x:pipe.x + 35, y:coinY, size:20, collected:false });
}

// -------------------- ТРУБЫ --------------------
function spawnPipe(){
    const minTop=50, maxTop=canvas.height-pipeGap-50;
    const topHeight=Math.random()*(maxTop-minTop)+minTop;
    pipes.push({x:canvas.width, top:topHeight, bottom:topHeight+pipeGap, passed:false, coinSpawned:false});
}

// -------------------- УПРАВЛЕНИЕ --------------------
function jump(){
    if(!gameActive){ restart(); return; }
    bird.velocity = jumpPower;
}
document.addEventListener("click", jump);
document.addEventListener("touchstart", jump);
document.addEventListener("keydown", e => { if(e.code==="Space") jump(); });

// -------------------- ОБНОВЛЕНИЕ --------------------
function update(){
    if(!gameActive) return;
    bird.velocity += gravity;
    bird.y += bird.velocity;

    if(bird.y<0 || bird.y+bird.size>canvas.height) endGame();

    pipes.forEach(pipe=>{
        pipe.x -= pipeSpeed;

        // коллизия
        if(bird.x<pipe.x+70 && bird.x+bird.size>pipe.x && (bird.y<pipe.top || bird.y+bird.size>pipe.bottom)){
            endGame();
        }

        // подсчет очков
        if(!pipe.passed && bird.x>pipe.x+70){
            pipe.passed=true;
            score++;
        }

        // спавн монетки
        if(!pipe.coinSpawned){ spawnCoin(pipe); pipe.coinSpawned=true; }
    });

    // монетки
    coins.forEach(c=>{
        c.x -= pipeSpeed;
        if(!c.collected && bird.x<c.x+c.size && bird.x+bird.size>c.x &&
           bird.y<c.y+c.size && bird.y+bird.size>c.y){
               c.collected=true; coinsCollected++;
        }
    });

    pipes = pipes.filter(p=>p.x>-100);
    coins = coins.filter(c=>c.x>-50 && !c.collected);
}

// -------------------- ОТРИСОВКА --------------------
function drawBackground(){
    if(!bg.complete){ ctx.fillStyle="#87CEEB"; ctx.fillRect(0,0,canvas.width,canvas.height); return; }
    const scale = Math.max(canvas.width/bg.width, canvas.height/bg.height);
    const x=(canvas.width-bg.width*scale)/2, y=(canvas.height-bg.height*scale)/2;
    ctx.drawImage(bg,x,y,bg.width*scale,bg.height*scale);
}

function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawBackground();
    ctx.fillStyle="yellow"; ctx.fillRect(bird.x,bird.y,bird.size,bird.size);
    ctx.fillStyle="green"; pipes.forEach(p=>{ ctx.fillRect(p.x,0,70,p.top); ctx.fillRect(p.x,p.bottom,70,canvas.height-p.bottom); });
    ctx.fillStyle="gold"; coins.forEach(c=>{ ctx.beginPath(); ctx.arc(c.x+c.size/2,c.y+c.size/2,c.size/2,0,Math.PI*2); ctx.fill(); });
    ctx.fillStyle="white"; ctx.font="40px Arial"; ctx.fillText("Score: "+score,30,60); ctx.fillText("Coins: "+coinsCollected,30,110);
    if(!gameActive && score===0){ ctx.fillText("Tap to Start",canvas.width/2-110,canvas.height/2); }
    if(!gameActive && score>0){ ctx.fillStyle="red"; ctx.font="50px Arial"; ctx.fillText("GAME OVER",canvas.width/2-150,canvas.height/2);
                               ctx.fillStyle="white"; ctx.font="30px Arial"; ctx.fillText("Tap to restart",canvas.width/2-100,canvas.height/2+40); }
}

// -------------------- RESTART --------------------
function restart(){
    bird.y=canvas.height/2; bird.velocity=0; pipes=[]; coins=[]; coinsCollected=0; score=0; gameActive=true;
    clearInterval(pipeTimer); pipeTimer=setInterval(spawnPipe,pipeSpawnInterval);
}

// -------------------- GAME LOOP --------------------
function gameLoop(){ update(); draw(); requestAnimationFrame(gameLoop); }
bg.onload=()=>{ gameLoop(); };

// -------------------- SEND TO BOT --------------------
function endGame(){
    if(!gameActive) return;
    gameActive=false;
    if(window.Telegram && Telegram.WebApp){
        Telegram.WebApp.sendData(JSON.stringify({score:score,coins:coinsCollected,game:"flappy"}));
    }
}

window.addEventListener("resize",()=>{ canvas.width=window.innerWidth; canvas.height=window.innerHeight; });

</script>
</body>
</html>

